<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LINE GPS 打卡</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { text-align: center; font-family: Arial, sans-serif; }
        .checkinBtn { padding: 10px 20px; font-size: 18px; cursor: pointer; margin: 5px; }
    </style>
</head>
<body>
    <h2>LINE GPS 打卡</h2>
    <button class="checkinBtn" id="workCheckin">上班打卡</button>
    <button class="checkinBtn" id="workCheckout">下班打卡</button>

    <script>
        const scriptURL = "https://script.google.com/macros/s/AKfycbzKf0ZToYHZ8LRm-uMvcpkZDPLKBkjFilQQ2PVVKDtyq60awxYL6BOcRTVPydLQPyE/exec";  

        document.addEventListener("DOMContentLoaded", async function() {
            try {
                await liff.init({ liffId: "2006937784-P4mr1RLD" });
                if (!liff.isLoggedIn()) liff.login();
            } catch (err) {
                console.error("❌ LIFF 初始化失敗", err);
            }
        });

        async function sendCheckin(status) {
            if (!navigator.geolocation) {
                alert("❌ 瀏覽器不支援 GPS 位置。");
                return;
            }

            navigator.geolocation.getCurrentPosition(async position => {
                let latitude = position.coords.latitude;
                let longitude = position.coords.longitude;

                try {
                    const profile = await liff.getProfile();
                    let userId = profile.userId;

                    let gpsData = { userId, latitude, longitude, status };
                    console.log("🔹 傳送打卡資料:", gpsData);

                    fetch(scriptURL, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(gpsData)
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert(`✅ 打卡成功！\n${status}`);
                            liff.closeWindow();
                        } else {
                            alert(`⚠️ 打卡失敗: ${data.error}`);
                        }
                    })
                    .catch(error => {
                        alert(`⚠️ 伺服器錯誤: ${error.message}`);
                    });

                } catch (error) {
                    alert("⚠️ 無法取得用戶資訊，請重新登入！");
                }
            }, error => {
                alert("⚠️ GPS 取得失敗：" + error.message);
            }, { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 });
        }

        document.getElementById("workCheckin").addEventListener("click", function() {
            sendCheckin("上班");
        });

        document.getElementById("workCheckout").addEventListener("click", function() {
            sendCheckin("下班");
        });
    </script>
</body>
</html>
