<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LINE GPS æ‰“å¡</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { text-align: center; font-family: Arial, sans-serif; }
        .checkinBtn { padding: 10px 20px; font-size: 18px; cursor: pointer; margin: 5px; }
    </style>
</head>
<body>
    <h2>LINE GPS æ‰“å¡</h2>
    <button class="checkinBtn" id="workCheckin">ä¸Šç­æ‰“å¡</button>
    <button class="checkinBtn" id="workCheckout">ä¸‹ç­æ‰“å¡</button>

    <script>
        const scriptURL = "https://script.google.com/macros/s/AKfycbzKf0ZToYHZ8LRm-uMvcpkZDPLKBkjFilQQ2PVVKDtyq60awxYL6BOcRTVPydLQPyE/exec";  

        document.addEventListener("DOMContentLoaded", async function() {
            try {
                await liff.init({ liffId: "2006937784-P4mr1RLD" });
                if (!liff.isLoggedIn()) liff.login();
            } catch (err) {
                console.error("âŒ LIFF åˆå§‹åŒ–å¤±æ•—", err);
            }
        });

        async function sendCheckin(status) {
            if (!navigator.geolocation) {
                alert("âŒ ç€è¦½å™¨ä¸æ”¯æ´ GPS ä½ç½®ã€‚");
                return;
            }

            navigator.geolocation.getCurrentPosition(async position => {
                let latitude = position.coords.latitude;
                let longitude = position.coords.longitude;

                try {
                    const profile = await liff.getProfile();
                    let userId = profile.userId;

                    let gpsData = { userId, latitude, longitude, status };
                    console.log("ğŸ”¹ å‚³é€æ‰“å¡è³‡æ–™:", gpsData);

                    fetch(scriptURL, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(gpsData)
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert(`âœ… æ‰“å¡æˆåŠŸï¼\n${status}`);
                            liff.closeWindow();
                        } else {
                            alert(`âš ï¸ æ‰“å¡å¤±æ•—: ${data.error}`);
                        }
                    })
                    .catch(error => {
                        alert(`âš ï¸ ä¼ºæœå™¨éŒ¯èª¤: ${error.message}`);
                    });

                } catch (error) {
                    alert("âš ï¸ ç„¡æ³•å–å¾—ç”¨æˆ¶è³‡è¨Šï¼Œè«‹é‡æ–°ç™»å…¥ï¼");
                }
            }, error => {
                alert("âš ï¸ GPS å–å¾—å¤±æ•—ï¼š" + error.message);
            }, { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 });
        }

        document.getElementById("workCheckin").addEventListener("click", function() {
            sendCheckin("ä¸Šç­");
        });

        document.getElementById("workCheckout").addEventListener("click", function() {
            sendCheckin("ä¸‹ç­");
        });
    </script>
</body>
</html>
