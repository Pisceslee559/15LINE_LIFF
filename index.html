<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LINE GPS 打卡</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { text-align: center; font-family: Arial, sans-serif; }
        .checkinBtn { padding: 10px 20px; font-size: 18px; cursor: pointer; margin: 5px; }
        #gpsInfo { margin-top: 10px; font-size: 16px; color: green; }
    </style>
</head>
<body>
    <h2>LINE GPS 打卡</h2>
    <p id="gpsInfo">GPS 位置讀取中...</p>
    <button class="checkinBtn" id="workCheckin">上班打卡</button>
    <button class="checkinBtn" id="workCheckout">下班打卡</button>

    <script>
        const scriptURL = "https://script.google.com/macros/s/AKfycbzhAwd6l8sHqKWMOGROFR4pcaHFG-hoc7UxZ62yeXiqy0EoF_3SdnVyyNRCsEOosvA/exec";  
        let latitude, longitude, userId, displayName;

        document.addEventListener("DOMContentLoaded", async function() {
            try {
                await liff.init({ liffId: "YOUR_LIFF_ID" });
                if (!liff.isLoggedIn()) liff.login();
                getLocation();
            } catch (err) {
                console.error("❌ LIFF 初始化失敗", err);
            }
        });

        function getLocation() {
            if (!navigator.geolocation) {
                document.getElementById("gpsInfo").innerText = "❌ 瀏覽器不支援 GPS";
                return;
            }

            navigator.geolocation.getCurrentPosition(
                position => {
                    latitude = position.coords.latitude;
                    longitude = position.coords.longitude;
                    document.getElementById("gpsInfo").innerText = `✅ GPS 取得成功：緯度 ${latitude}，經度 ${longitude}`;
                    console.log("✅ GPS 取得成功:", latitude, longitude);
                },
                error => {
                    document.getElementById("gpsInfo").innerText = `❌ GPS 失敗：${error.message}`;
                    console.error("❌ GPS 失敗:", error);
                },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );
        }

        async function sendCheckin(status) {
            if (!latitude || !longitude) {
                alert("⚠️ GPS 位置尚未取得，請稍候再試！");
                return;
            }

            try {
                const profile = await liff.getProfile();
                userId = profile.userId;
                displayName = profile.displayName;
            } catch (error) {
                alert("⚠️ 無法取得用戶資訊，請重新登入！");
                return;
            }

            let gpsData = { userId, latitude, longitude, status };
            console.log("🔹 傳送打卡資料:", gpsData);

            fetch(scriptURL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(gpsData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`✅ 打卡成功！\n${status}`);
                    liff.closeWindow();
                } else {
                    alert(`⚠️ 打卡失敗: ${data.error}`);
                }
            })
            .catch(error => {
                alert(`⚠️ 伺服器錯誤: ${error.message}`);
            });
        }

        document.getElementById("workCheckin").addEventListener("click", function() {
            sendCheckin("上班");
        });

        document.getElementById("workCheckout").addEventListener("click", function() {
            sendCheckin("下班");
        });
    </script>
</body>
</html>
