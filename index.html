<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LINE GPS æ‰“å¡</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { text-align: center; font-family: Arial, sans-serif; }
        .checkinBtn { padding: 10px 20px; font-size: 18px; cursor: pointer; margin: 5px; }
        #gpsInfo { margin-top: 10px; font-size: 16px; color: green; }
    </style>
</head>
<body>
    <h2>LINE GPS æ‰“å¡</h2>
    <p id="gpsInfo">GPS ä½ç½®è®€å–ä¸­...</p>
    <button class="checkinBtn" id="workCheckin">ä¸Šç­æ‰“å¡</button>
    <button class="checkinBtn" id="workCheckout">ä¸‹ç­æ‰“å¡</button>

    <script>
        const scriptURL = "https://script.google.com/macros/s/AKfycbzhAwd6l8sHqKWMOGROFR4pcaHFG-hoc7UxZ62yeXiqy0EoF_3SdnVyyNRCsEOosvA/exec";  
        let latitude, longitude, userId, displayName;

        document.addEventListener("DOMContentLoaded", async function() {
            try {
                await liff.init({ liffId: "YOUR_LIFF_ID" });
                if (!liff.isLoggedIn()) liff.login();
                getLocation();
            } catch (err) {
                console.error("âŒ LIFF åˆå§‹åŒ–å¤±æ•—", err);
            }
        });

        function getLocation() {
            if (!navigator.geolocation) {
                document.getElementById("gpsInfo").innerText = "âŒ ç€è¦½å™¨ä¸æ”¯æ´ GPS";
                return;
            }

            navigator.geolocation.getCurrentPosition(
                position => {
                    latitude = position.coords.latitude;
                    longitude = position.coords.longitude;
                    document.getElementById("gpsInfo").innerText = `âœ… GPS å–å¾—æˆåŠŸï¼šç·¯åº¦ ${latitude}ï¼Œç¶“åº¦ ${longitude}`;
                    console.log("âœ… GPS å–å¾—æˆåŠŸ:", latitude, longitude);
                },
                error => {
                    document.getElementById("gpsInfo").innerText = `âŒ GPS å¤±æ•—ï¼š${error.message}`;
                    console.error("âŒ GPS å¤±æ•—:", error);
                },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );
        }

        async function sendCheckin(status) {
            if (!latitude || !longitude) {
                alert("âš ï¸ GPS ä½ç½®å°šæœªå–å¾—ï¼Œè«‹ç¨å€™å†è©¦ï¼");
                return;
            }

            try {
                const profile = await liff.getProfile();
                userId = profile.userId;
                displayName = profile.displayName;
            } catch (error) {
                alert("âš ï¸ ç„¡æ³•å–å¾—ç”¨æˆ¶è³‡è¨Šï¼Œè«‹é‡æ–°ç™»å…¥ï¼");
                return;
            }

            let gpsData = { userId, latitude, longitude, status };
            console.log("ğŸ”¹ å‚³é€æ‰“å¡è³‡æ–™:", gpsData);

            fetch(scriptURL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(gpsData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`âœ… æ‰“å¡æˆåŠŸï¼\n${status}`);
                    liff.closeWindow();
                } else {
                    alert(`âš ï¸ æ‰“å¡å¤±æ•—: ${data.error}`);
                }
            })
            .catch(error => {
                alert(`âš ï¸ ä¼ºæœå™¨éŒ¯èª¤: ${error.message}`);
            });
        }

        document.getElementById("workCheckin").addEventListener("click", function() {
            sendCheckin("ä¸Šç­");
        });

        document.getElementById("workCheckout").addEventListener("click", function() {
            sendCheckin("ä¸‹ç­");
        });
    </script>
</body>
</html>
